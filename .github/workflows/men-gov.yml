name: Continuous Python Runner

on:
  workflow_dispatch:
    inputs:
      loops:
        description: "Remaining handoffs (0 = infinite)"
        required: false
        default: "0"

concurrency:
  group: python-continuous-singleton
  cancel-in-progress: false

permissions:
  contents: write
  actions: write

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: ðŸ‡²ðŸ‡¦ Get Morocco Proxy
        id: proxy
        run: |
          # Fetch a free Morocco proxy from a public API
          # We try to get an HTTPS/HTTP proxy that is currently up
          PROXY=$(curl -s "https://proxyscrape.com/free-proxy-list/morocco" | grep -m 1 -oP '\d+\.\d+\.\d+\.\d+:\d+')
          if [ -z "$PROXY" ]; then
            echo "âš ï¸ No free Morocco proxy found. Script might fail if geo-blocked."
          else
            echo "Using Morocco Proxy: $PROXY"
            echo "proxy_url=http://$PROXY" >> $GITHUB_OUTPUT
            # Set environment variables so 'requests' uses it automatically
            echo "HTTP_PROXY=http://$PROXY" >> $GITHUB_ENV
            echo "HTTPS_PROXY=http://$PROXY" >> $GITHUB_ENV
          fi

      - name: ðŸš€ Run Python Script (Background)
        run: |
          touch script_output.log
          # Using -u for real-time logs
          python3 -u men.gov.py > script_output.log 2>&1 &
          echo "PYTHON_PID=$!" >> $GITHUB_ENV
          echo "Script started with PID: $!"

      - name: â³ Execution Loop & Real-time Logs
        run: |
          RUNTIME_SECS=$((345 * 60))
          END_TIME=$(($(date +%s) + RUNTIME_SECS))
          
          echo "--- START OF LIVE LOGS (IP: $(curl -s https://ifconfig.me/ip || echo 'Check failed')) ---"
          tail -n +1 --pid=$PYTHON_PID -f script_output.log &
          
          while [[ $(date +%s) -lt $END_TIME ]]; do
            if ! kill -0 $PYTHON_PID 2>/dev/null; then
              echo "âš ï¸ Script exited or finished early."
              break
            fi
            sleep 60
          done
          echo "--- END OF LIVE LOGS ---"

      - name: ðŸ’¾ Save State and Restart
        if: always()
        run: |
          if kill -0 $PYTHON_PID 2>/dev/null; then
            kill $PYTHON_PID
            sleep 5
          fi

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if [ -f last_announcement_id.txt ]; then
            git add last_announcement_id.txt
            git diff --staged --quiet || (git commit -m "Update state [skip ci]" && git push)
          fi

          LOOPS=${{ github.event.inputs.loops }}
          NEXT=$(( LOOPS > 1 ? LOOPS - 1 : 0 ))
          if [[ "$LOOPS" -ne "1" ]]; then
            curl -X POST \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/men-gov.yml/dispatches" \
              -d "{\"ref\":\"${{ github.ref_name }}\",\"inputs\":{\"loops\":\"$NEXT\"}}"
          fi
