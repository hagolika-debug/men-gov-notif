name: Continuous Python Runner

on:
  workflow_dispatch:
    inputs:
      loops:
        description: "Remaining handoffs (0 = infinite)"
        required: false
        default: "0"

concurrency:
  group: python-continuous-singleton
  cancel-in-progress: false

permissions:
  contents: write
  actions: write

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: ðŸš€ Run Python Script (Background)
        run: |
          # Start script, capture all output to log file, and run unbuffered (-u)
          touch script_output.log
          python3 -u men.gov.py > script_output.log 2>&1 &
          echo "PYTHON_PID=$!" >> $GITHUB_ENV
          echo "Script started with PID: $!"

      - name: â³ Execution Loop & Real-time Logs
        run: |
          RUNTIME_SECS=$((345 * 60))
          END_TIME=$(($(date +%s) + RUNTIME_SECS))
          
          echo "--- START OF LIVE LOGS ---"
          # Stream the log file in the background, stops automatically when PID dies
          tail -n +1 --pid=$PYTHON_PID -f script_output.log &
          
          while [[ $(date +%s) -lt $END_TIME ]]; do
            if ! kill -0 $PYTHON_PID 2>/dev/null; then
              echo "âš ï¸ Script exited or finished early."
              break
            fi
            
            # Print a status heartbeat every 10 mins without breaking the log stream
            LEFT=$(( (END_TIME - $(date +%s)) / 60 ))
            if (( LEFT % 10 == 0 )); then
               echo "[System Info]: $LEFT minutes remaining until handoff."
            fi
            sleep 60
          done
          echo "--- END OF LIVE LOGS ---"

      - name: ðŸ’¾ Save State and Restart
        if: always()
        run: |
          echo "Stopping Python script and saving state..."
          
          if kill -0 $PYTHON_PID 2>/dev/null; then
            kill $PYTHON_PID
            sleep 5
          fi

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if [ -f last_announcement_id.txt ]; then
            git add last_announcement_id.txt
            if ! git diff --staged --quiet; then
              git commit -m "Update state: last_announcement_id [skip ci]"
              git push
            else
              echo "No changes to last_announcement_id.txt. Skipping push."
            fi
          fi

          LOOPS=${{ github.event.inputs.loops }}
          if [[ "$LOOPS" -eq "1" ]]; then
            echo "Reached loop limit. Exiting."
            exit 0
          fi

          NEXT=$(( LOOPS > 1 ? LOOPS - 1 : 0 ))

          echo "Dispatching next run (Loops remaining: $NEXT)..."
          
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/men-gov.yml/dispatches" \
            -d "{\"ref\":\"${{ github.ref_name }}\",\"inputs\":{\"loops\":\"$NEXT\"}}"
