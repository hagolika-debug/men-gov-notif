name: Continuous Python Runner

on:
  workflow_dispatch:
    inputs:
      loops:
        description: "Remaining handoffs (0 = infinite)"
        required: false
        default: "0"

# Prevents multiple instances from running and conflicting over the state file
concurrency:
  group: python-continuous-singleton
  cancel-in-progress: false

permissions:
  contents: write    # Required to commit/push last_announcement_id.txt
  actions: write     # Required to trigger the next workflow run

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history so git push works smoothly

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: ðŸš€ Run Python Script (Background)
        run: |
          # Start the script in the background and save its process ID
          python3 men.gov.py &
          echo "PYTHON_PID=$!" >> $GITHUB_ENV
          echo "Script started with PID: $!"

      - name: â³ Execution Loop
        run: |
          # Define runtime: 345 minutes (approx 5.75 hours)
          # This leaves 15 minutes for state saving and handoff
          RUNTIME_SECS=$((345 * 60))
          END_TIME=$(($(date +%s) + RUNTIME_SECS))
          
          echo "Monitoring men.gov.py for 345 minutes..."
          
          while [[ $(date +%s) -lt $END_TIME ]]; do
            # Check if the process is still running
            if ! kill -0 $PYTHON_PID 2>/dev/null; then
              echo "âš ï¸ Script exited or finished early. Stopping loop."
              break
            fi
            
            LEFT=$(( (END_TIME - $(date +%s)) / 60 ))
            if (( LEFT % 10 == 0 )); then
               echo "Session active... ($LEFT min until handoff)"
            fi
            sleep 60
          done

      - name: ðŸ’¾ Save State and Restart
        if: always()
        run: |
          echo "Stopping Python script and saving state..."
          
          # 1. Kill the script if it's still running so it stops writing
          if kill -0 $PYTHON_PID 2>/dev/null; then
            kill $PYTHON_PID
            sleep 5
          fi

          # 2. Configure Git for the automated bot
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 3. Add and Commit the state file
          if [ -f last_announcement_id.txt ]; then
            git add last_announcement_id.txt
            # Only commit and push if the file actually changed
            if ! git diff --staged --quiet; then
              git commit -m "Update state: last_announcement_id [skip ci]"
              git push
            else
              echo "No changes to last_announcement_id.txt. Skipping push."
            fi
          fi

          # 4. Handle Recursive Handoff
          LOOPS=${{ github.event.inputs.loops }}
          
          if [[ "$LOOPS" -eq "1" ]]; then
            echo "Reached loop limit. Exiting."
            exit 0
          fi

          # Calculate next loop count
          if [[ "$LOOPS" -gt "1" ]]; then
            NEXT=$((LOOPS - 1))
          else
            NEXT=0 # Infinite mode
          fi

          echo "Dispatching next run (Loops remaining: $NEXT)..."
          
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/men-gov.yml/dispatches" \
            -d "{\"ref\":\"${{ github.ref_name }}\",\"inputs\":{\"loops\":\"$NEXT\"}}"
